---
title: "分布式学习手记08 - ZooKeeper 核心技术（下）"
categories:
  - 分布式
date: 2019-1-7
toc: true
toc_label: "核心技术"
toc_icon: "align-left"
header:
  teaser: /assets/images/fbs_teaser.gif
---

> ZooKeeper 的核心技术细节，包括：系统模型、序列化与协议、客户端工作原理、会话、服务端工作原理以及数据存储等方面。

## 服务器启动

五个主要步骤：配置文件解析、初始化数据管理器、初始化网络I/O管理器、数据恢复和对外服务，单机和集群模式的启动流程有所差别。

### 单机版服务器启动

预启动

1. 由 QuorumPeerMain 作为启动类

2. 解析配置文件 zoo.cfg

3. 创建并启动历史文件清理器 DatadirCleanupManager

   包括对事务日志和快照数据文件进行定时清理

4. 判断当前是集群模式还是单机模式的启动

   若是单机模式，委托给 ZooKeeperServerMain 进行启动处理

5. 再次解析 zoo.cfg

6. 创建服务器实例 ZooKeeperServer

   实例创建后，对该实例进行初始化工作：包括连接器、内存数据库、请求处理器等组件的初始化

初始化

1. 创建服务器统计器 ServerStats

   采集服务器基本的运行时信息

2. 创建数据管理器 FileTxnSnapLog

   FileTxnSnapLog 是 ZooKeeper 上层服务器和底层数据存储之间的对接层，提供操作数据文件的接口，包括事务日志文件和快照数据文件

3. 设置服务器 tickTime 和会话超时时限

4. 创建 ServerCnxnFactory

   可以指定使用内部 NIO 或者 Netty 框架来作为 ZooKeeper 服务端网络连接工厂

5. 初始化 ServerCnxnFactory

6. 启动 ServerCnxnFactory 主线程

7. 恢复本地数据

   ZooKeeper 启动时，需要从本地快照和事务日志中进行数据恢复

8. 创建并启动会话管理器 SessionTracker

9. 初始化 ZooKeeper 的请求处理链

10. 注册 JMX 服务

    服务器运行时相关信息以 JMX 的方式暴露给外部

11. 注册 ZooKeeper 服务器实例

    将初始化完毕的 ZooKeeper 实例注册给 ServerCnxnFactory，开始对外提供服务

### 集群版服务器启动

预启动

1. 由 QuorumPeerMain 作为启动类

2. 解析配置文件 zoo.cfg

3. 创建并启动历史文件清理器 DatadirCleanupManager

4. 判断当前是集群模式还是单机模式的启动

初始化

1. 创建 ServerCnxnFactory

2. 初始化 ServerCnxnFactory

3. 创建数据管理器 FileTxnSnapLog

4. 创建 QuorumPeer 实例

   Quorum 是集群模式下服务器实例的托管者，运行期间 QuorumPeer 会不断检测服务器实例运行状态，根据情况发起 Leader 选举

5. 创建内存数据库 ZKDatabase

   ZKDatabase 管理所有会话记录、DataTree 和事务日志的存储

6. 初始化 QuorumPeer

   将核心组件注册到 QuorumPeer 中去，并配置集群相关参数

7. 恢复本地数据

8. 启动 ServerCnxnFactory 主线程

Leader 选举

1. 初始化 Leader 选举

   创建 Leader 选举所需的网络 I/O 层 QuorumCnxManager，启动选举端口监听

2. 注册 JMX 服务

3. 检测当前服务器状态

   由 QuorumPeer 不断检测当前服务器的状态，做出相应处理

4. Leader 选举

   集群内机器互相进行一系列投票，选举产生 Leader，其余机器成为 Follower 或 Observer

Leader 和 Follower 启动期交互过程

1. 创建 Leader 服务器和 Follower 服务器

   选举完成后，各服务器根据自身角色创建相应实例，进入该角色主流程

2. Leader 服务器启动信息接收器 LearnerCnxAcceptor

   LearnerCnxAcceptor 负责所有非 Leader 服务器（以下称为 Learner）的连接请求

3. Learner 服务器和 Leader 建立连接

4. Leader 服务器创建 LearnerHandler

   Leader 接收到其他机器连接创建请求后，对每一个 Leader 与 Learner 的连接，创建一个 LearnerHandler 实例，负责二者间消息通信和数据同步

5. 向 Leader 注册

   Learner 向 Leader 发送自己的基本信息 LearnerInfo

6. Leader 解析 Learner 信息，计算新的 epoch

7. 发送 Leader 状态

8. Learner 发送 ACK 消息

9. 数据同步

10. 启动 Leader 和 Learner 服务器

    当有过半的 Learner 完成了数据同步，则 Leader 和 Learner 服务器实例可以开始启动了

Leader 和 Follower 启动

1. 创建并启动会话管理器

2. 初始化 ZooKeeper 的请求处理链

3. 注册 JMX 服务
